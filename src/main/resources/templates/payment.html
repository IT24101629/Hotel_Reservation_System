<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Payment - Hotel Reservation System</title>
</head>
<body>
    <div th:fragment="content">
        <!-- Hero Section -->
        <section class="hero-section" style="background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/images/banner/pay.jpg') center/cover no-repeat;">
            <div class="container">
                <div class="text-center">
                    <div class="fade-in-up">
                        <h1 class="display-4 mb-6 text-golden">
                            <i class="fas fa-credit-card me-3"></i>
                            Secure Payment
                        </h1>
                    </div>
                    <div class="fade-in-up" style="animation-delay: 0.2s;">
                        <p class="lead mb-8">
                            Complete your payment to confirm your booking at Golden Palm Hotel
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <div class="container">
            
            <!-- Payment Container -->
            <div class="booking-container">
                <!-- Payment Form -->
                <div class="card shadow-glow">
                    <div class="card-header">
                        <h2 class="mb-0">
                            <i class="fas fa-credit-card text-golden me-3"></i>
                            Payment Information
                        </h2>
                    </div>
                    <div class="card-body">
                        <!-- Booking Information Display -->
                        <div id="bookingInfo" class="mb-3" th:if="${booking != null}">
                            <h3 class="text-golden mb-3"><i class="fas fa-clipboard-check me-2"></i>Booking Confirmation</h3>
                            <div class="card">
                                <div class="card-body">
                                    <div id="bookingDetails">
                                        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div>
                                                <p><strong>Booking Reference:</strong> <span id="bookingReference" th:text="${booking.bookingReference}">-</span></p>
                                                <p><strong>Room:</strong> <span id="roomDetails" th:text="${booking.roomNumber + ' (' + booking.roomType + ')'}">-</span></p>
                                                <p><strong>Guest Name:</strong> <span id="guestName" th:text="${booking.customerName}">-</span></p>
                                            </div>
                                            <div>
                                                <p><strong>Check-in:</strong> <span id="checkInDisplay" th:text="${#temporals.format(booking.checkInDate, 'EEE, MMM dd, yyyy')}">-</span></p>
                                                <p><strong>Check-out:</strong> <span id="checkOutDisplay" th:text="${#temporals.format(booking.checkOutDate, 'EEE, MMM dd, yyyy')}">-</span></p>
                                                <p><strong>Duration:</strong> <span id="durationDisplay" th:text="${booking.numberOfNights + (booking.numberOfNights > 1 ? ' nights' : ' night')}">-</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Method Selection -->
                        <div class="form-group">
                            <h3 class="text-golden mb-3"><i class="fas fa-wallet me-2"></i>Select Payment Method</h3>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="payment-method-card selected" data-method="CREDIT_CARD">
                                        <div class="payment-method-icon">
                                            <i class="fas fa-credit-card"></i>
                                        </div>
                                        <h4>Credit/Debit Card</h4>
                                        <p class="mb-2">Secure online payment</p>
                                        <small>Visa, Mastercard, American Express</small>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="payment-method-card" data-method="BANK_TRANSFER">
                                        <div class="payment-method-icon">
                                            <i class="fas fa-university"></i>
                                        </div>
                                        <h4>Bank Transfer</h4>
                                        <p class="mb-2">Direct bank transfer</p>
                                        <small>Manual verification required</small>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="payment-method-card" data-method="CASH">
                                        <div class="payment-method-icon">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </div>
                                        <h4>Pay at Hotel</h4>
                                        <p class="mb-2">Pay upon arrival</p>
                                        <small>Cash or card at reception</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Credit Card Payment Form -->
                        <div id="creditCardPaymentSection" class="form-group">
                            <h3 class="text-golden mb-3"><i class="fas fa-credit-card me-2"></i>Credit/Debit Card Payment</h3>
                            <div class="card">
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <strong><i class="fas fa-lock me-1"></i>Secure Payment:</strong> Your payment is processed securely. We do not store your card details on our servers.
                                    </div>
                                    
                                    <form id="creditCardPaymentForm" novalidate>
                                        <!-- CSRF Token -->
                                        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                                        <input type="hidden" id="bookingReferenceField" name="bookingReference">
                                        <input type="hidden" id="paymentAmountField" name="amount">
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="cardholderName">Cardholder Name *</label>
                                                    <input type="text" id="cardholderName" name="cardholderName" 
                                                           class="form-control" required 
                                                           placeholder="John Doe"
                                                           pattern="[A-Za-z\s]{2,50}"
                                                           title="Please enter the name as it appears on your card">
                                                    <div class="invalid-feedback">Please enter cardholder name (2-50 characters)</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="cardNumber">Card Number *</label>
                                                    <input type="text" id="cardNumber" name="cardNumber" 
                                                           class="form-control" required 
                                                           placeholder="1234 5678 9012 3456"
                                                           maxlength="19"
                                                           pattern="[0-9\s]{13,19}"
                                                           title="Please enter a valid card number">
                                                    <div class="invalid-feedback">Please enter a valid card number</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="expiryDate">Expiry Date *</label>
                                                    <input type="text" id="expiryDate" name="expiryDate" 
                                                           class="form-control" required 
                                                           placeholder="MM/YY"
                                                           maxlength="5"
                                                           pattern="(0[1-9]|1[0-2])\/\d{2}"
                                                           title="Please enter expiry date in MM/YY format">
                                                    <div class="invalid-feedback">Please enter expiry date (MM/YY)</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="cvv">CVV *</label>
                                                    <input type="text" id="cvv" name="cvv" 
                                                           class="form-control" required 
                                                           placeholder="123"
                                                           maxlength="4"
                                                           pattern="\d{3,4}"
                                                           title="Please enter the 3 or 4 digit CVV code">
                                                    <div class="invalid-feedback">Please enter CVV (3-4 digits)</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Payment Summary in Form -->
                                        <div class="payment-form-summary">
                                            <h4>Payment Summary</h4>
                                            <div class="summary-item">
                                                <span>Total Amount:</span>
                                                <span id="paymentAmount" class="total-amount" th:text="${booking != null ? 'LKR ' + #numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 2, 'POINT') : 'LKR 0.00'}">LKR 0.00</span>
                                            </div>
                                            <div class="summary-item">
                                                <span>Payment Method:</span>
                                                <span>Credit/Debit Card</span>
                                            </div>
                                            <div class="summary-item">
                                                <span>Processing Fee:</span>
                                                <span>Included</span>
                                            </div>
                                        </div>
                                        
                                        <div class="form-check mt-3">
                                            <input type="checkbox" id="termsAccepted" class="form-check-input" required>
                                            <label for="termsAccepted" class="form-check-label">
                                                I agree to the <a href="/terms" target="_blank">Terms and Conditions</a> and <a href="/privacy" target="_blank">Privacy Policy</a>
                                            </label>
                                            <div class="invalid-feedback">You must accept the terms and conditions</div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button type="submit" id="payNowBtn" class="btn btn-success form-control" disabled>
                                                <i class="fas fa-lock me-2"></i>Process Payment Securely
                                            </button>
                                            <div id="paymentProgress" class="mt-2" style="display: none;">
                                                <div class="spinner"></div>
                                                <span>Processing payment...</span>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bank Transfer Instructions -->
                        <div id="bankTransferSection" class="form-group" style="display: none;">
                            <h3 class="text-golden mb-3"><i class="fas fa-university me-2"></i>Bank Transfer Details</h3>
                            <div class="card">
                                <div class="card-body">
                                    <div class="alert alert-warning">
                                        <strong><i class="fas fa-exclamation-triangle me-1"></i>Important:</strong> Your booking will be on hold until payment is verified. Please transfer the exact amount and send proof of payment.
                                    </div>
                                    
                                    <h4>Bank Details:</h4>
                                    <div class="bank-details">
                                        <p><strong>Bank:</strong> Commercial Bank of Ceylon PLC</p>
                                        <p><strong>Account Name:</strong> Gold Palm Hotel (Pvt) Ltd</p>
                                        <p><strong>Account Number:</strong> 8001234567890</p>
                                        <p><strong>Branch:</strong> Colombo Main Branch</p>
                                        <p><strong>SWIFT Code:</strong> CCEYLKLX</p>
                                    </div>
                                    
                                    <h4 class="mt-3">Transfer Instructions:</h4>
                                    <ol>
                                        <li>Transfer the exact amount: <strong id="bankTransferAmount" th:text="${booking != null ? 'LKR ' + #numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 2, 'POINT') : 'LKR 0.00'}">LKR 0.00</strong></li>
                                        <li>Use booking reference <strong id="bankTransferReference" th:text="${booking != null ? booking.bookingReference : '-'}">-</strong> as the transfer reference</li>
                                        <li>Email proof of payment to: <strong>payments@goldpalmhotel.com</strong></li>
                                        <li>Include your booking reference in the email subject</li>
                                    </ol>
                                    
                                    <div class="mt-3">
                                        <button type="button" id="confirmBankTransferBtn" class="btn btn-primary form-control">
                                            <i class="fas fa-envelope me-2"></i>I will transfer the amount and send proof
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cash Payment Section -->
                        <div id="cashPaymentSection" class="form-group" style="display: none;">
                            <h3 class="text-golden mb-3"><i class="fas fa-money-bill-wave me-2"></i>Pay at Hotel</h3>
                            <div class="card">
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <strong><i class="fas fa-lightbulb me-1"></i>Payment at Hotel:</strong> You can pay when you arrive at the hotel. Your booking will be held for 24 hours.
                                    </div>
                                    
                                    <h4>Payment Information:</h4>
                                    <ul>
                                        <li>Amount to pay: <strong id="cashPaymentAmount" th:text="${booking != null ? 'LKR ' + #numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 2, 'POINT') : 'LKR 0.00'}">LKR 0.00</strong></li>
                                        <li>Payment methods accepted: Cash, Credit Card, Debit Card</li>
                                        <li>Pay at the reception desk during check-in</li>
                                        <li>Booking reference: <strong id="cashPaymentReference" th:text="${booking != null ? booking.bookingReference : '-'}">-</strong></li>
                                    </ul>
                                    
                                    <div class="alert alert-warning">
                                        <strong><i class="fas fa-exclamation-triangle me-1"></i>Important:</strong>
                                        <ul class="mb-0">
                                            <li>Your booking will be automatically cancelled if payment is not made within 24 hours of arrival</li>
                                            <li>Please bring a valid government-issued photo ID</li>
                                            <li>Late arrivals (after 10 PM) should inform the hotel in advance</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button type="button" id="confirmCashPaymentBtn" class="btn btn-success form-control">
                                            <i class="fas fa-check-circle me-2"></i>Confirm Booking - Pay at Hotel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terms and Security Info -->
                        <div class="form-group">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="text-golden mb-3"><i class="fas fa-shield-alt me-2"></i>Security & Terms</h4>
                                    <div style="font-size: 0.9rem; line-height: 1.4;">
                                        <p><strong>Security:</strong> All payments are processed through SSL encrypted connections. Your card details are never stored on our servers.</p>
                                        <p><strong>Refunds:</strong> Cancellations made 24+ hours before check-in are eligible for full refund. Processing time: 3-5 business days.</p>
                                        <p><strong>Booking Policy:</strong> By proceeding with payment, you agree to our terms and conditions and cancellation policy.</p>
                                        <p><strong>Support:</strong> For payment issues, contact us at <strong>support@goldpalmhotel.com</strong> or <strong>+94 11 1234567</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Summary Sidebar -->
                <div class="booking-summary card shadow-glow">
                    <div class="card-header">
                        <h3 class="mb-0 text-golden"><i class="fas fa-file-invoice-dollar me-2"></i>Payment Summary</h3>
                    </div>
                    <div class="card-body" th:if="${booking != null}">
                        <div id="paymentSummaryContent">
                        <div id="paymentSummaryDetails">
                            <!-- Room Details -->
                            <div class="summary-section">
                                <h4><i class="fas fa-hotel me-2 text-golden"></i>Booking Details</h4>
                                <div class="summary-item">
                                    <span>Room:</span>
                                    <span id="summaryRoomType" th:text="${booking.roomType}">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Dates:</span>
                                    <span id="summaryDates" th:text="${#temporals.format(booking.checkInDate, 'MMM dd') + ' - ' + #temporals.format(booking.checkOutDate, 'MMM dd')}">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Guests:</span>
                                    <span id="summaryGuests" th:text="${booking.numberOfGuests + (booking.numberOfGuests > 1 ? ' guests' : ' guest')}">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Duration:</span>
                                    <span id="summaryNights" th:text="${booking.numberOfNights + (booking.numberOfNights > 1 ? ' nights' : ' night')}">-</span>
                                </div>
                            </div>

                            <!-- Price Breakdown -->
                            <div class="summary-section">
                                <h4><i class="fas fa-calculator me-2 text-golden"></i>Price Breakdown</h4>
                                <div class="summary-item">
                                    <span>Room rate:</span>
                                    <span id="summaryRoomRate" th:text="${'LKR ' + #numbers.formatDecimal(booking.roomPricePerNight, 0, 'COMMA', 2, 'POINT') + ' × ' + booking.numberOfNights}">-</span>
                                </div>
                                <div class="summary-item" th:with="subtotal=${booking.roomPricePerNight * booking.numberOfNights}">
                                    <span>Subtotal:</span>
                                    <span id="summarySubtotal" th:text="${'LKR ' + #numbers.formatDecimal(subtotal, 0, 'COMMA', 2, 'POINT')}">-</span>
                                </div>
                                <div class="summary-item" th:with="subtotal=${booking.roomPricePerNight * booking.numberOfNights}, serviceCharge=${subtotal * 0.10}">
                                    <span>Service charge (10%):</span>
                                    <span id="summaryServiceCharge" th:text="${'LKR ' + #numbers.formatDecimal(serviceCharge, 0, 'COMMA', 2, 'POINT')}">-</span>
                                </div>
                                <div class="summary-item" th:with="subtotal=${booking.roomPricePerNight * booking.numberOfNights}, taxes=${subtotal * 0.02}">
                                    <span>Taxes (2%):</span>
                                    <span id="summaryTaxes" th:text="${'LKR ' + #numbers.formatDecimal(taxes, 0, 'COMMA', 2, 'POINT')}">-</span>
                                </div>
                            </div>

                            <!-- Total -->
                            <div class="total-amount">
                                <div class="summary-item">
                                    <span>Total Amount:</span>
                                    <span id="summaryTotal" th:text="${'LKR ' + #numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 2, 'POINT')}">LKR 0.00</span>
                                </div>
                            </div>

                            <!-- Payment Security -->
                            <div class="mt-2">
                                <div class="alert alert-success" style="padding: 0.75rem; font-size: 0.9rem;">
                                    <strong><i class="fas fa-lock me-1"></i>100% Secure</strong><br>
                                    SSL encrypted<br>
                                    PCI DSS compliant<br>
                                    No card details stored
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
</div>
    
    <!-- Additional JavaScript for payment page -->
    <th:block th:fragment="additional-js">
        <script th:inline="javascript">
            /*<![CDATA[*/
            // Get booking data from server-side
            const paymentBookingData = /*[[${booking}]]*/ null;
            let selectedPaymentMethod = 'CREDIT_CARD';

            // Global error handler
            window.addEventListener('error', function(e) {
                console.error('JavaScript error on payment page:', e.error);
                console.error('Error details:', e.filename, e.lineno, e.colno);
            });

            document.addEventListener('DOMContentLoaded', function() {
                console.log('Payment page DOM loaded, starting initialization');

                // Extra safety check - only run payment JavaScript if we're actually on payment page
                if (window.location.pathname !== '/payment') {
                    console.log('Payment JavaScript attempted to run on wrong page:', window.location.pathname);
                    return;
                }

                // Check if booking data is available
                if (!paymentBookingData) {
                    console.log('Payment page accessed without valid booking data');
                    alert('No booking data found. Redirecting to bookings page.');
                    window.location.replace('/my-bookings');
                    return;
                }

                try {
                    console.log('Payment page: Booking data loaded from server:', paymentBookingData);
                    setupPaymentForm(paymentBookingData);
                    updatePaymentAmounts(paymentBookingData);
                    initializePaymentMethods();
                } catch (error) {
                    console.error('Error during payment page initialization:', error);
                }
            });
            /*]]>*/

            function updatePaymentAmounts(booking) {
                // Update payment amount displays for different payment methods
                const totalAmount = booking.totalAmount;
                const formattedAmount = formatCurrency(totalAmount);

                const paymentAmountEl = document.getElementById('paymentAmount');
                const bankTransferAmountEl = document.getElementById('bankTransferAmount');
                const cashPaymentAmountEl = document.getElementById('cashPaymentAmount');
                const bankTransferRefEl = document.getElementById('bankTransferReference');
                const cashPaymentRefEl = document.getElementById('cashPaymentReference');

                if (paymentAmountEl) paymentAmountEl.textContent = formattedAmount;
                if (bankTransferAmountEl) bankTransferAmountEl.textContent = formattedAmount;
                if (cashPaymentAmountEl) cashPaymentAmountEl.textContent = formattedAmount;
                if (bankTransferRefEl) bankTransferRefEl.textContent = booking.bookingReference;
                if (cashPaymentRefEl) cashPaymentRefEl.textContent = booking.bookingReference;
            }
            
            function setupPaymentForm(booking) {
                console.log('Payment page: Setting up custom payment form with booking:', booking);
                
                // Setup custom payment form
                document.getElementById('bookingReferenceField').value = booking.bookingReference;
                document.getElementById('paymentAmountField').value = booking.totalAmount.toFixed(2);
                
                console.log('Payment page: Custom payment form fields populated');
                
                // Payment button will be enabled by form validation
                console.log('Payment page: Payment form ready');
            }
            
            function initializePaymentMethods() {
                // Attach click event listeners to payment method cards
                document.querySelectorAll('.payment-method-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const method = this.getAttribute('data-method');
                        selectPaymentMethod(method);
                    });
                });

                // Attach event listeners to alternative payment buttons
                const bankTransferBtn = document.getElementById('confirmBankTransferBtn');
                if (bankTransferBtn) {
                    bankTransferBtn.addEventListener('click', confirmBankTransfer);
                }

                const cashPaymentBtn = document.getElementById('confirmCashPaymentBtn');
                if (cashPaymentBtn) {
                    cashPaymentBtn.addEventListener('click', confirmCashPayment);
                }

                // Set initial payment method
                selectPaymentMethod('CREDIT_CARD');
                setupCreditCardForm();
            }

            function selectPaymentMethod(method) {
                selectedPaymentMethod = method;

                // Update UI
                document.querySelectorAll('.payment-method-card').forEach(el => {
                    el.classList.remove('selected');
                });
                const selectedCard = document.querySelector(`[data-method="${method}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }

                // Show/hide payment sections
                document.getElementById('creditCardPaymentSection').style.display = method === 'CREDIT_CARD' ? 'block' : 'none';
                document.getElementById('bankTransferSection').style.display = method === 'BANK_TRANSFER' ? 'block' : 'none';
                document.getElementById('cashPaymentSection').style.display = method === 'CASH' ? 'block' : 'none';
            }
            
            function setupCreditCardForm() {
                const form = document.getElementById('creditCardPaymentForm');
                if (!form) return;
                
                // Add input formatting
                const cardNumberInput = document.getElementById('cardNumber');
                const expiryDateInput = document.getElementById('expiryDate');
                const cvvInput = document.getElementById('cvv');
                
                // Format card number with spaces
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || '';
                    e.target.value = formattedValue;
                });
                
                // Format expiry date with slash
                expiryDateInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
                
                // Restrict CVV to numbers only
                cvvInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
                
                // Enable/disable pay button based on form validity
                form.addEventListener('input', function() {
                    const payBtn = document.getElementById('payNowBtn');
                    const termsCheckbox = document.getElementById('termsAccepted');
                    const isValid = form.checkValidity() && termsCheckbox.checked;
                    payBtn.disabled = !isValid;
                });
                
                // Handle form submission
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (form.checkValidity()) {
                        processCustomPayment();
                    } else {
                        form.classList.add('was-validated');
                    }
                });
            }
            
            function processCustomPayment() {
                const form = document.getElementById('creditCardPaymentForm');
                const formData = new FormData(form);

                const paymentData = {
                    bookingReference: paymentBookingData.bookingReference,
                    cardNumber: formData.get('cardNumber'),
                    expiryDate: formData.get('expiryDate'),
                    cvv: formData.get('cvv'),
                    cardholderName: formData.get('cardholderName'),
                    amount: paymentBookingData.totalAmount
                };
                
                // Show loading
                document.getElementById('paymentProgress').style.display = 'block';
                document.getElementById('payNowBtn').disabled = true;
                
                fetch('/api/custom-payment/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]')?.value || ''
                    },
                    body: JSON.stringify(paymentData)
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('paymentProgress').style.display = 'none';
                    
                    if (data.success) {
                        showAlert('Payment successful! Redirecting to confirmation...', 'success');
                        setTimeout(() => {
                            window.location.href = '/payment/success?order_id=' + data.bookingReference;
                        }, 2000);
                    } else {
                        showAlert(data.error || 'Payment failed. Please try again.', 'error');
                        document.getElementById('payNowBtn').disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Payment error:', error);
                    document.getElementById('paymentProgress').style.display = 'none';
                    document.getElementById('payNowBtn').disabled = false;
                    showAlert('Payment processing failed. Please try again.', 'error');
                });
            }
            
            function confirmBankTransfer() {
                if (confirm('Please confirm that you will transfer the payment and send proof to our email. Your booking will be on hold until payment is verified.')) {
                    processAlternativePayment('BANK_TRANSFER');
                }
            }
            
            function confirmCashPayment() {
                if (confirm('Please confirm that you will pay at the hotel during check-in. Your booking will be held for 24 hours from your arrival time.')) {
                    processAlternativePayment('CASH');
                }
            }
            
            function processAlternativePayment(paymentMethod) {
                showLoading('Processing your booking...');

                fetch('/api/payment/alternative', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]')?.value || ''
                    },
                    body: JSON.stringify({
                        bookingId: paymentBookingData.bookingId,
                        paymentMethod: paymentMethod
                    })
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showAlert('Booking confirmed! You will receive a confirmation email shortly.', 'success');
                        setTimeout(() => {
                            window.location.href = '/booking/confirmation?bookingId=' + paymentBookingData.bookingId;
                        }, 2000);
                    } else {
                        showAlert(data.error || 'Error processing payment. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Payment processing error:', error);
                    showAlert('Error processing payment. Please try again.', 'error');
                });
            }
            
            // Custom payment form is handled in setupCreditCardForm function
            
            function formatCurrency(amount) {
                return `LKR ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            }
            
            // Test payment function removed - custom payment system handles validation internally
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            function formatDateShort(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            }
        </script>
    </th:block>
    
    <!-- Additional CSS for payment page -->
    <th:block th:fragment="additional-css">
        <style>
            .payment-method-card {
                cursor: pointer;
                transition: all 0.3s ease;
                padding: 2rem 1.5rem;
                border: 2px solid #dee2e6;
                border-radius: 12px;
                background: #ffffff;
                text-align: center;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .payment-method-icon {
                width: 70px;
                height: 70px;
                border-radius: 50%;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 1.25rem;
                transition: all 0.3s ease;
            }

            .payment-method-icon i {
                font-size: 2rem;
                color: #666;
                transition: all 0.3s ease;
            }

            .payment-method-card h4 {
                margin-bottom: 0.75rem;
                color: #333;
                font-size: 1.1rem;
                font-weight: 600;
            }

            .payment-method-card p {
                margin-bottom: 0.5rem;
                color: #666;
                font-size: 0.95rem;
            }

            .payment-method-card small {
                color: #999;
                font-size: 0.85rem;
                display: block;
            }

            .payment-method-card:hover {
                background: #f8f9fa;
                border-color: #ffd700;
                transform: translateY(-4px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            }

            .payment-method-card:hover .payment-method-icon {
                background: linear-gradient(135deg, #fff9e6 0%, #ffeaa7 100%);
                transform: scale(1.1);
            }

            .payment-method-card:hover .payment-method-icon i {
                color: #d4af37;
            }

            .payment-method-card.selected {
                background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
                border-color: #ffd700;
                box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4);
                border-width: 3px;
            }

            .payment-method-card.selected .payment-method-icon {
                background: linear-gradient(135deg, #ffd700 0%, #d4af37 100%);
                box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
            }

            .payment-method-card.selected .payment-method-icon i {
                color: #ffffff;
            }

            .payment-method-card.selected h4 {
                color: #d4af37;
                font-weight: 700;
            }

            .payment-method-card.selected p {
                color: #555;
            }

            .payment-method-card.selected small {
                color: #777;
            }

            .summary-section {
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid #e0e0e0;
            }

            .summary-section:last-of-type {
                border-bottom: none;
            }

            .summary-section h4 {
                font-size: 1rem;
                margin-bottom: 1rem;
                color: #333;
            }

            .summary-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.75rem;
                color: #555;
            }

            .summary-item span:first-child {
                color: #666;
            }

            .summary-item span:last-child {
                font-weight: 500;
                color: #333;
            }

            .total-amount {
                background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
                padding: 1rem;
                border-radius: 8px;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }

            .total-amount .summary-item span {
                font-size: 1.2rem;
                font-weight: bold;
                color: #d4af37;
            }

            .sticky-top {
                top: 2rem;
            }
        </style>
    </th:block>
</body>
</html>